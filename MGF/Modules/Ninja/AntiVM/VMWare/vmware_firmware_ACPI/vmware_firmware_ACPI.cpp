#include "vmware_firmware_ACPI.h"

/*
Check for ACPI firmware
*/
void vmware_firmware_ACPI()
{
	BOOL result = FALSE;

	PDWORD tableNames = static_cast<PDWORD>(malloc(4096));
	SecureZeroMemory(tableNames, 4096);
	DWORD tableSize = EnumSystemFirmwareTables(static_cast<DWORD>('ACPI'), tableNames, 4096);
	DWORD tableCount = tableSize / 4;
	if (tableSize < 4 || tableCount == 0)
		result = TRUE;
	else
	{
		for (DWORD i = 0; i < tableCount; i++) {
			DWORD tableSize = 0;
			PBYTE table = get_system_firmware(static_cast<DWORD>('ACPI'), tableNames[i], &tableSize);

			PBYTE vmwareString = (PBYTE)"VMWARE";
			size_t vmwwareStringLen = 6;


			if (find_str_in_data(vmwareString, vmwwareStringLen, table, tableSize)) {
				result = TRUE;
			}

			free(table);
		}
	}

	free(tableNames);
	if (result)
		exit(1);
}