#include "adbg_CheckWindowName.h"

#define SHOW_DEBUG_MESSAGES

// =======================================================================
// Memory Checks
// These checks focus on Windows structures containing information which 
// can reveal the presence of a debugger. 
// =======================================================================


/*
* // adbg_CheckWindowName()
*
* // How it works:
* Checks for a window with a specific Class name. This name is
* not the title of the Window. Use tools like Nirsoft Winlister
* to find this value.
*
* // Indication:
* Look for FindWindow on the imports list or strings of common
* begugger names. Some exeptions exist, like in the case of IDA
* whose window Class name is "QWidget" and nothing related to IDA.
*
* // Bypass:
* Set a breakpoint on FindWindow, single step, then
* switch the return value to 0.
*/
void adbg_CheckWindowName(void)
{
	BOOL found = FALSE;
	HANDLE hWindow = NULL;
	LPCSTR WindowClassNameIDA = "Qt5QWindowIcon";	// IDA Pro
	LPCSTR WindowClassNameOlly = "OLLYDBG";			// OllyDbg
	LPCSTR WindowClassNameImmunity = "ID";			// Immunity Debugger
	
	// Check for IDA Pro
	hWindow = FindWindow(WindowClassNameIDA, 0);
	if (hWindow)
	{
		found = TRUE;
	}
	
	// Check for OllyDBG
	hWindow = FindWindow(WindowClassNameOlly, 0);
	if (hWindow)
	{
		found = TRUE;
	}
	
	// Check for Immunity
	hWindow = FindWindow(WindowClassNameImmunity, 0);
	if (hWindow)
	{
		found = TRUE;
	}

	if (found)
	{
		printf("Caught by FindWindow!");
		exit(1);
	}
}

