#include "RegistryRun.h"

bool GetKeyData(HKEY hRootKey, LPCSTR subKey, LPCSTR value, LPDWORD lpType, LPBYTE data, DWORD *cbData)
{
	HKEY hKey;
	bool ret = true;
	if (RegOpenKeyExA(hRootKey, subKey, 0, KEY_QUERY_VALUE, &hKey) != ERROR_SUCCESS)
		ret = false;

	if (RegQueryValueExA(hKey, value, NULL, lpType, data, cbData) != ERROR_SUCCESS)
	{
		RegCloseKey(hKey);
		ret = false;
	}

	RegCloseKey(hKey);
	return ret;
}

bool SetKeyData(HKEY hRootKey, LPCSTR subKey, DWORD dwType, LPCSTR value, LPBYTE data, DWORD cbData)
{
	HKEY hKey;
	bool ret = true;
	if (RegCreateKeyA(hRootKey, subKey, &hKey) != ERROR_SUCCESS)
		ret = false;

	if (RegSetValueExA(hKey, value, 0, dwType, data, cbData) != ERROR_SUCCESS)
	{
		RegCloseKey(hKey);
		ret = false;
	}

	RegCloseKey(hKey);
	return ret;
}

bool RegistryRun()
{
	char pathfile[MAX_PATH];
	GetModuleFileNameA(NULL, pathfile, MAX_PATH);
	char *filename = PathFindFileName(pathfile);
	return SetKeyData(HKEY_CURRENT_USER, "Software\\Microsoft\\Windows\\CurrentVersion\\Run", REG_SZ, filename, (LPBYTE)pathfile, strlen(pathfile));
}